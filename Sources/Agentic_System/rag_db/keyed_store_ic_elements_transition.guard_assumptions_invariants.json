{
  "body": "Guard assumptions & invariants (source-anchored)\n\nSummary: This document catalogs the guard conditions, invariants, and protector/validity checks that keyed element stores rely upon across the IC, CSA/builtins, elements accessor implementations, and compiler lowering. The document enumerates exact code locations that enforce each guard and describes the consequence (miss/slow/runtime call/deopt) when the guard fails.\n\nMain guard categories and anchors:\n1) Map checks / receiver type checks\n  - IC-level lookup_start_object_map and UpdateState uses update_lookup_start_object_map and FirstTargetMap to derive monomorphic map checks (ic/ic.cc: lines ~1-400 and KeyedStoreIC::UpdateStoreElement: ic/ic.cc:2273-2413). Compiler guard lowering also emits Map checks (compiler/* files: simplified-lowering.cc:4746 and load-elimination.cc:1366-1411).\n2) ElementsKind checks\n  - EmitElementStore dispatch in builtins uses DispatchByElementsKind and checks elements kind via LoadElementsKind(receiver) and LoadMapElementsKind(map) (builtins/builtins-handler-gen.cc: Generate_ElementsTransitionAndStore, lines ~141-176). Handler bitfields include ElementsKindBits (ic/handler-configuration.h:118-132). Maglev nodes BuildTransitionElementsKindOrCheckMap handle map/element-kind checks in maglev/maglev-graph-builder.cc:4367-4466.\n3) In-bounds vs OOB checks and typed-array semantics\n  - KeyedAccessStoreMode is derived in KeyedStoreIC::GetStoreMode which uses IsOutOfBoundsAccess and JSArray bounds logic (ic/ic.cc: GetStoreMode/GetStoreMode callers around 1800-2000). Typed array stores use PrepareValueForWriteToTypedArray and EmitElementStoreTypedArray which enforce OOB/detached buffer semantics (codegen/code-stub-assembler.cc:13646-14037; builtins/builtins-typed-array-gen.cc:558-591). If allow OOB mode is set (KeyedAccessStoreMode::kIgnoreTypedArrayOOB) the builtins avoid triggering runtime miss and instead return early.\n4) Copy-on-write (COW) and EnsureWritable\n  - CopyElementsOnWrite and CheckForCapacityGrow in CSA implement COW detection and call CopyElementsOnWrite when elements->IsCowArray() or when growth is required (codegen/code-stub-assembler.cc:14240-14359). KeyedStoreIC encodes store_mode bits for handling COW (ic/ic.cc: GetStoreMode and StoreElementHandler selection around 2400-2520). When EnsureWritable fails, software falls back to runtime slow path.\n5) Prototype chain validity / protector cells\n  - KeyedStoreIC attaches validity cells via Map::GetOrCreatePrototypeChainValidityCell to handlers to ensure prototype chain hasn't been invalidated. See ic/ic.cc: StoreElementHandler and where validity_cell is set and StoreHandler object wrapping occurs (ic/ic.cc:~2500). Protectors like Protectors::IsNoElementsIntact are checked in various places (ic/ic.cc allow convert hole checks) to determine whether holes can be treated as undefined.\n6) Dictionary-promotion / non-fast elements rejection\n  - If receiver map has dictionary elements or the prototype chain contains dictionary elements, KeyedStoreIC falls back to slow handlers; code references: ic/ic.cc logic around UpdateStoreElement and StoreElementPolymorphicHandlers and objects/elements.cc conversion routines which may return failure if conversion to fast elements is not possible.\n7) Write barrier preconditions and emission sites\n  - Write barrier code paths are present in EmitElementStore and in elements conversion routines where a HeapObject is stored. Look for RecordWrite / StoreBuffer calls emitted in codegen/code-stub-assembler.cc:14094-14219 and objects/elements.cc conversion spots where HeapObjects are written into new element arrays.\n\nFor each guard, consequence when it fails: IC miss -> KeyedStoreIC miss runtime call (Runtime::kKeyedStoreIC_Miss) or TailCall to ElementsTransitionAndStoreIC_Miss for transition builtins. Miss handling paths are anchored in builtins/builtins-handler-gen.cc where TailCallRuntime(...Miss) is invoked and in ic/ic.cc runtime entry handlers (ic/ic.cc:3113 and ic/ic.cc:3242).\n\nInternal RAG citation IDs used: [keyed_store_ic_elements_transition.elements_accessor_transitions, keyed_store_ic_elements_transition.handlers_catalog, keyed_store_ic_elements_transition.overview_topology]\n\nFileLine anchors: ic/ic.cc:2273-2548; builtins/builtins-handler-gen.cc:141-193; codegen/code-stub-assembler.cc:13646-14359; objects/elements.cc:991-1114; ic/accessor-assembler.cc:579-732; maglev/maglev-graph-builder.cc:4367-4480",
  "context": [
    "keyed_store_ic_elements_transition.elements_accessor_transitions",
    "keyed_store_ic_elements_transition.handlers_catalog",
    "keyed_store_ic_elements_transition.overview_topology"
  ],
  "explanation": "Systematic listing of all guards, where they're implemented, and what the IC/builtins/runtime do when they fail (miss, slow path, deopt). Useful for threat analysis and compiler lowering correctness checks.",
  "file_line": "ic/ic.cc:2273-2548; builtins/builtins-handler-gen.cc:141-193; codegen/code-stub-assembler.cc:13646-14359; objects/elements.cc:991-1114; ic/accessor-assembler.cc:579-732"
}