{
  "body": "File: src/wasm/wrappers.cc\nSymbols and roles:\n- WasmWrapperTSGraphBuilder (class): Turboshaft graph builder for all wrapper kinds.\n  - GetBuiltinCallDescriptor(Builtin, Zone*): Create TSCallDescriptor for a builtin in kCallBuiltinPointer mode.\n  - ModifyThreadInWasmFlagScope (RAII): Loads Isolate::thread_in_wasm_flag_address and toggles it via BuildModifyThreadInWasmFlagHelper(true/false) when trap handler enabled.\n  - BuildJSToWasmWrapper(do_conversion, frame_state, set_in_wasm_flag): Entry for JS\u2192Wasm wrapper graph. Validates JS-compat signature, sets up JS closure/context, optional fast-path conversion via FromJSFast/CanTransformFast, default conversion via FromJS, calls into wasm via BuildCallAndReturn which uses BuildCallWasmFromWrapper, then converts returns to JS (ToJS) including multi-return via AllocateJSArray and stores elements.\n  - BuildWasmToJSWrapper(kind, expected_arity, suspend): Entry for Wasm\u2192JS import wrapper. Builds wasm parameter list, loads native_context and callable, handles kRuntimeTypeError path, constructs JS call either via JSCallDescriptor or CallTrampoline builtin depending on ImportCallKind. Clears thread-in-wasm flag and optionally switches to central stack (BuildSwitchToTheCentralStackIfNeeded/Back). Handles Suspend: BuildSuspend; converts result(s) via FromJS and returns to wasm. Sets source positions 0/1 for asm.js attribution.\n  - BuildCapiCallWrapper(): Entry for Wasm\u2192C API wrapper. Packs params into off-heap stack slot with SafeStore, loads WasmCapiFunctionData::kEmbedderData, toggles thread-in-wasm flag and sets c_entry_fp into isolate root, loads call target via code pointer table, calls C with (host_data_foreign, values), rethrows via Builtin::kWasmRethrowExplicitContext if non-zero return, then loads results via SafeLoad and returns.\n  - BuildCallWasmFromWrapper(zone, sig, callee, implicit_first_arg, args, returns): Constructs TSCallDescriptor from compiler::GetWasmCallDescriptor(WasmIndirectFunction), executes Call, and demultiplexes tuple returns.\n  - BuildCallAndReturn(js_context, function_data, args, do_conversion, set_in_wasm_flag): Wraps ModifyThreadInWasmFlagScope around the indirect wasm call (via internal function target and implicit arg), converts returns to JS (ToJS or build multireturn array).\n  - ToJS(ret, CanonicalValueType, context): Conversions for kI32\u2192Number, kI64\u2192BigInt, floats, refs: pass-through or for funcrefs convert WasmInternalFunction to external JSFunction via Builtin::kWasmInternalFunctionCreateExternal; handle nullability and WasmNull\u2192null for appropriate heap types.\n  - FromJS(input, context, CanonicalValueType, frame_state): Tagged\u2192wasm conversions. kI32 via inline Smi fast path falling back to Builtin::kWasmTaggedNonSmiToInt32; kF64 via Builtin::kWasmTaggedToFloat64; kI64 via BigIntToI64/I32Pair CallDescriptor from WasmCallDescriptors; refs via Runtime::kWasmJSToWasmObject except for extern/string fast checks.\n  - FromJSFast / CanTransformFast: Fast-path for Smi or HeapNumber for f32/f64/i32.\n  - BuildSuspend(value, import_data, old_sp*, old_limit): For Promise results in Wasm\u2192JS wrapper: ensure suspender present, perform PerformPromiseThen, switch back from central stack, call Builtin::kWasmSuspend, switch to central stack again, propagate resolved value; throw on illegal cases.\n  - Stack switching helpers: BuildSwitchToTheCentralStackIfNeeded, BuildSwitchToTheCentralStack(old_limit), BuildSwitchBackFromCentralStack(old_sp, old_limit), BuildSetNewStackLimit.\n  - GetBuiltinPointerTarget/GetTargetForBuiltinCall: targets builtins with StubCallMode::kCallBuiltinPointer.\n  - GetBuiltinCallDescriptor helper (file-static): wraps Builtins::CallInterfaceDescriptorFor + Linkage::GetStubCallDescriptor \u2192 TSCallDescriptor.\n  - BuildModifyThreadInWasmFlagHelper is referenced from RAII but defined in TF file; here a lighter BuildModifyThreadInWasmFlag(zone, bool) exists toggling flag for WasmToJS and CAPI.\n  - SafeStore/SafeLoad: store/load machine reps to/from off-heap buffer, special-casing compressible tagged with full word.\n  - Misc: BuildChangeInt32ToNumber/Float32/Float64, HeapNumberToFloat64, LoadMap/InstanceType, BuildCheckString.\n- BuildWasmWrapper(dispatcher): Free function selecting wrapper kind by WrapperCompilationInfo.code_kind: JS_TO_WASM_FUNCTION \u2192 BuildJSToWasmWrapper; WASM_TO_JS_FUNCTION \u2192 BuildWasmToJSWrapper(kind, expected_arity, suspend); WASM_TO_CAPI_FUNCTION \u2192 BuildCapiCallWrapper.\n",
  "context": [
    "tf_hooks",
    "call_desc",
    "runtime_tiering",
    "wasm_objects"
  ],
  "explanation": "This entry summarizes the Turboshaft-based wrapper builder in src/wasm/wrappers.cc. It anchors the core wrapper generation: JS\u2192Wasm, Wasm\u2192JS (imports), and Wasm\u2192C API, including conversion logic (ToJS/FromJS), thread-in-wasm flag, stack switching and suspension, and how wrapper calls into wasm (indirect call via internal function target). This is a primary reference for the wrapper region.",
  "file_line": "wasm/wrappers.cc:1-"
}