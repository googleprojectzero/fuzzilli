{
  "body": "File: src/compiler/bytecode-graph-builder.cc (selected snippets)\n\n// Core entry points\nvoid BytecodeGraphBuilder::VisitLdaLookupSlot() {\n  BuildLdaLookupSlot(TypeofMode::kNotInside);\n}\nvoid BytecodeGraphBuilder::VisitLdaLookupSlotInsideTypeof() {\n  BuildLdaLookupSlot(TypeofMode::kInside);\n}\nvoid BytecodeGraphBuilder::VisitStaLookupSlot() {\n  PrepareEagerCheckpoint();\n  Node* value = environment()->LookupAccumulator();\n  Node* name = jsgraph()->ConstantNoHole(MakeRefForConstantForIndexOperand(0), broker());\n  int bytecode_flags = bytecode_iterator().GetFlag8Operand(1);\n  LanguageMode language_mode = ...;\n  LookupHoistingMode lookup_hoisting_mode = ...;\n  const Operator* op = javascript()->CallRuntime(\n      is_strict(language_mode)\n          ? Runtime::kStoreLookupSlot_Strict\n          : lookup_hoisting_mode == LookupHoistingMode::kLegacySloppy\n                ? Runtime::kStoreLookupSlot_SloppyHoisting\n                : Runtime::kStoreLookupSlot_Sloppy);\n  Node* store = NewNode(op, name, value);\n  environment()->BindAccumulator(store, Environment::kAttachFrameState);\n}\n\n// Context/global lookup fast paths\nvoid BytecodeGraphBuilder::BuildLdaLookupContextSlot(ContextKind context_kind,\n                                                     TypeofMode typeof_mode) {\n  uint32_t depth = bytecode_iterator().GetUnsignedImmediateOperand(2);\n  Environment* slow_environment = CheckContextExtensions(depth);\n  {\n    uint32_t slot_index = bytecode_iterator().GetIndexOperand(1);\n    const Operator* op = context_kind == ContextKind::kScriptContext\n        ? javascript()->LoadScriptContext(depth, slot_index)\n        : javascript()->LoadContext(depth, slot_index, false);\n    environment()->BindAccumulator(NewNode(op));\n  }\n  if (!slow_environment) return;  // fully replaced by dependencies\n  NewMerge();\n  Environment* fast_environment = environment();\n  set_environment(slow_environment);\n  {\n    Node* name = jsgraph()->ConstantNoHole(MakeRefForConstantForIndexOperand(0), broker());\n    const Operator* op = javascript()->CallRuntime(typeof_mode == TypeofMode::kNotInside\n        ? Runtime::kLoadLookupSlot\n        : Runtime::kLoadLookupSlotInsideTypeof);\n    Node* value = NewNode(op, name);\n    environment()->BindAccumulator(value, Environment::kAttachFrameState);\n  }\n  fast_environment->Merge(environment(), ...);\n  set_environment(fast_environment);\n  mark_as_needing_eager_checkpoint(true);\n}\n\nvoid BytecodeGraphBuilder::BuildLdaLookupGlobalSlot(TypeofMode typeof_mode) {\n  uint32_t depth = bytecode_iterator().GetUnsignedImmediateOperand(2);\n  Environment* slow_environment = CheckContextExtensions(depth);\n  {\n    PrepareEagerCheckpoint();\n    NameRef name = MakeRefForConstantForIndexOperand<Name>(0);\n    uint32_t feedback_slot_index = bytecode_iterator().GetIndexOperand(1);\n    Node* node = BuildLoadGlobal(name, feedback_slot_index, typeof_mode);\n    environment()->BindAccumulator(node, Environment::kAttachFrameState);\n  }\n  if (!slow_environment) return;\n  NewMerge();\n  Environment* fast_environment = environment();\n  set_environment(slow_environment);\n  {\n    Node* name = jsgraph()->ConstantNoHole(MakeRefForConstantForIndexOperand<Name>(0), broker());\n    const Operator* op = javascript()->CallRuntime(typeof_mode == TypeofMode::kNotInside\n        ? Runtime::kLoadLookupSlot\n        : Runtime::kLoadLookupSlotInsideTypeof);\n    Node* value = NewNode(op, name);\n    environment()->BindAccumulator(value, Environment::kAttachFrameState);\n  }\n  fast_environment->Merge(environment(), ...);\n  set_environment(fast_environment);\n  mark_as_needing_eager_checkpoint(true);\n}\n\n// Extension checking logic\nOptionalScopeInfoRef BytecodeGraphBuilder::TryGetScopeInfo() {\n  Node* context = environment()->Context();\n  switch (context->opcode()) {\n    case IrOpcode::kJSCreateFunctionContext: return CreateFunctionContextParametersOf(context->op()).scope_info();\n    case IrOpcode::kJSCreateBlockContext:\n    case IrOpcode::kJSCreateCatchContext:\n    case IrOpcode::kJSCreateWithContext: return ScopeInfoOf(context->op());\n    case IrOpcode::kParameter: {\n      ScopeInfoRef scope_info = shared_info_.scope_info(broker());\n      if (scope_info.HasOuterScopeInfo()) scope_info = scope_info.OuterScopeInfo(broker());\n      return scope_info;\n    }\n    default: return std::nullopt;\n  }\n}\n\nBytecodeGraphBuilder::Environment* BytecodeGraphBuilder::CheckContextExtensions(uint32_t depth) {\n  OptionalScopeInfoRef maybe_scope_info = TryGetScopeInfo();\n  if (!maybe_scope_info.has_value()) { return CheckContextExtensionsSlowPath(depth); }\n  ScopeInfoRef scope_info = maybe_scope_info.value();\n  Environment* slow_environment = nullptr;\n  for (uint32_t d = 0; d < depth; d++) {\n    DCHECK_NE(scope_info.scope_type(), ScopeType::SCRIPT_SCOPE);\n    DCHECK_NE(scope_info.scope_type(), ScopeType::REPL_MODE_SCOPE);\n    if (scope_info.HasContextExtensionSlot() &&\n        !broker()->dependencies()->DependOnEmptyContextExtension(scope_info)) {\n      slow_environment = CheckContextExtensionAtDepth(slow_environment, d);\n    }\n    if (scope_info.HasOuterScopeInfo()) scope_info = scope_info.OuterScopeInfo(broker());\n  }\n  DCHECK_IMPLIES(!v8_flags.empty_context_extension_dep, slow_environment != nullptr);\n  return slow_environment;\n}\n\nBytecodeGraphBuilder::Environment* BytecodeGraphBuilder::CheckContextExtensionsSlowPath(uint32_t depth) {\n  Environment* slow_environment = nullptr;\n  for (uint32_t d = 0; d < depth; d++) {\n    Node* has_extension = NewNode(javascript()->HasContextExtension(d));\n    Environment* undefined_extension_env;\n    NewBranch(has_extension);\n    {\n      SubEnvironment sub_environment(this);\n      NewIfTrue();\n      slow_environment = CheckContextExtensionAtDepth(slow_environment, d);\n      undefined_extension_env = environment();\n    }\n    NewIfFalse();\n    environment()->Merge(undefined_extension_env, ...);\n    mark_as_needing_eager_checkpoint(true);\n  }\n  DCHECK_NOT_NULL(slow_environment);\n  return slow_environment;\n}\n\nBytecodeGraphBuilder::Environment* BytecodeGraphBuilder::CheckContextExtensionAtDepth(Environment* slow_environment, uint32_t depth) {\n  Node* extension_slot = NewNode(javascript()->LoadContext(depth, Context::EXTENSION_INDEX, false));\n  Node* check_no_extension = NewNode(simplified()->ReferenceEqual(), extension_slot, jsgraph()->UndefinedConstant());\n  NewBranch(check_no_extension);\n  {\n    SubEnvironment sub_environment(this);\n    NewIfFalse();\n    if (slow_environment == nullptr) { slow_environment = environment(); NewMerge(); }\n    else { slow_environment->Merge(environment(), ...); }\n  }\n  NewIfTrue();\n  return slow_environment;\n}\n",
  "context": [
    "bgb_lookup_paths",
    "bgb_CreateWithContext_emit"
  ],
  "explanation": "Shows how TurboFan's bytecode graph builder emits fast paths for LdaLookupContext/GlobalSlot via context extension checks and merges in a slow-path to runtime LoadLookupSlot. Also covers store path and the extension gating logic with dependencies to elide dynamic checks.",
  "file_line": "bytecode-graph-builder.cc:1796-2067, 1833-1908"
}